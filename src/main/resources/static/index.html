<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>文件上传</title>
  </head>
  <body>
    <div class="container">
      <input id="upload" type="file" multiple="multiple"/>
      <div id="uploadBtn" class="upload-btn">upload</div>
      <div style="border-bottom: 1px solid grey; width: 60vw; margin-bottom: 10px"></div>
      <div id="progress" class="progress-container" style="display: none"></div>
    </div>
  </body>
  <script>
    const uploadSliceSize = 2 * 1024 * 1024
    /**
     *{filename : {
     *            index: memory interrupt index of file
     *            chunks: memory chunks for each file
     *            file: memory file object
     *            flag: memory pause(false) or uploading(true)
     *            }}
     * */

    const memoryStatus = {}

    function abortOrContinueUpload(filename) {
      if (memoryStatus[filename].flag) {
        console.log(this.currentTarget)
        document.getElementById(`${filename}-status`).innerText = '继续'
      } else {
        xhrSend(memoryStatus[filename].index, memoryStatus[filename].chunks, memoryStatus[filename].file)
        document.getElementById(`${filename}-status`).innerText = '中止'
      }
      memoryStatus[filename].flag = !memoryStatus[filename].flag
    }

    function uploadFile(file) {
      let start = 0, size = file.size, chunks = [], percent = 0
      while (start < size) {
        let fileSlice = start + uploadSliceSize <= size ? file.slice(start, start + uploadSliceSize) : file.slice(start, size)
        chunks.push(fileSlice)
        start += uploadSliceSize
      }
      memoryStatus[file.name].chunks = chunks
      memoryStatus[file.name].file = file
      memoryStatus[file.name].flag = true
      let node = document.createElement('div')
      node.setAttribute('id', file.name)
      node.setAttribute('class', 'progress-item')
      node.innerHTML = `<div class="progress-item-1">${file.name}</div>
                        <div id="${file.name}-percent" class="progress-item-2">${percent}%</div>
                        <div id="${file.name}-status"
                             class="progress-item-3"
                             onclick="abortOrContinueUpload('${file.name}')">
                             中止
                        </div>
                       `
      document.getElementById('progress').append(node)
      xhrSend(0, chunks, file)
    }

    function xhrSend(index, chunks, file) {
      let formData = new FormData()
      formData.append('file-data', chunks[index], file.name)
      formData.append('meta-data', `${index}`)
      let xhr = new XMLHttpRequest()
      memoryStatus[file.name].index = index
      xhr.open('POST', '/api/upload')
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (!memoryStatus[file.name].flag) {
            memoryStatus[file.name].index = index + 1
            return
          }
          if (index + 1 < chunks.length) {
            xhrSend(index + 1, chunks, file)
          } else {
            let node = document.getElementById(file.name)
            node.parentNode.removeChild(node)
            let xhrMerge = new XMLHttpRequest()
            xhrMerge.open('GET', `/api/merge/${file.name}/${chunks.length}`)
            xhrMerge.send()
          }
        }
      }
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          let percent = (index * uploadSliceSize + e.loaded) / file.size * 100
          percent = percent >= 100 ? 100 : percent
          document.getElementById(`${file.name}-percent`).innerText = `${percent.toFixed(2)}%`
        }
      }
      xhr.onerror = () => {
        memoryStatus[file.name].index = index
        abortOrContinueUpload(file.name)
        console.log("upload error")
      }
      xhr.send(formData)
    }

    window.onload = () => {
      document.getElementById("upload").addEventListener("change", (event) => {
        let files = event.currentTarget.files, totalBytes = 0
        for (let i = 0; i < files.length; i++) totalBytes += files[i].size
      })
      document.getElementById("uploadBtn").addEventListener("click", () => {
        let files = document.getElementById("upload").files
        document.getElementById('progress').style.display = ''
        for (let i = 0; i < files.length; i++) {
          memoryStatus[files[i].name] = {}
          uploadFile(files[i])
        }
      })
    }
  </script>
  <style type="text/css">
    body,
    html {
      margin: 0;
      padding: 0;
      font-family: "Helvetica", serif;
    }

    input {
      border: solid 2px grey;
      outline: none;
      margin: 1rem;
      border-radius: 4px;
      font-size: 1.2rem;
      text-align: center;
    }

    .container {
      margin-top: 15vh;
      height: 100vh;
      width: 100vw;
      overflow: scroll;
      display: flex;
      flex-flow: column;
      align-items: center;
    }

    .progress-container {
      border-radius: 10px;
      width: 60vw;
    }

    .progress-item {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 5px;
    }

    .progress-item-1 {
      width: 75%;
    }

    .progress-item-2 {
      width: 15%;
    }

    .progress-item-3 {
      width: 15%;
      cursor: pointer;
    }

    .upload-btn {
      cursor: pointer;
      margin: 10px;
      border: 3px solid black;
      border-radius: 10px;
      width: 60px;
      padding: 10px;
      display: flex;
      flex-flow: row;
      justify-content: center;
      align-items: center;
    }
  </style>
</html>